---
- name: include secret vars
  include_vars: secrets.yml

- name: Create RG
  azure_rm_resourcegroup:
    name: phonebookApp
    location: "{{ primary_azure_region }}"
  tags:
    - recipe4

- name: Create storage account
  azure_rm_storageaccount:
    resource_group: phonebookApp
    name: examplestorage01aljdl
    type: Standard_LRS
    location: "{{ primary_azure_region }}"
  tags:
    - recipe4

- name: create vnet
  azure_rm_virtualnetwork:
    name: vnet01
    resource_group: phonebookApp
    address_prefixes_cidr:
    - "10.2.0.0/16"
    - "172.1.0.0/16"
    tags:
      env: testing
    state: present
  tags:
  - recipe2

- name: create public ip
  azure_rm_publicipaddress:
    resource_group: phonebookApp
    name: pip01
    allocation_method: Static
    domain_name: ox-phonebook
    state: present
  register: publicip
  tags:
  - recipe3

- name: show public IP
  debug:
    msg: "{{ publicip['ip_address'] }}"
  tags:
  - recipe3

- name: create subnet
  azure_rm_subnet:
    name: subnet01
    virtual_network_name: vnet01
    resource_group: phonebookApp
    address_prefix_cidr: "10.2.0.0/24"
    state: present
    # security_group_name: mysg01
  tags:
  - recipe5

- name: create nic for pip
  azure_rm_networkinterface:
    name: nic02
    resource_group: phonebookApp
    virtual_network_name: vnet01
    subnet_name: subnet01
    public_ip_address_name: pip01
    security_group_name: mysg01
    state: present
  register: nic2
  tags:
  - recipe4

- name: show private ip
  debug:
    msg: "{{ nic2.ip_configuration.private_ip_address }}"
  tags:
  - recipe2

- name: create vm using nic02
  azure_rm_virtualmachine:
    resource_group: phonebookApp
    state: present
    name: phonebookVM-FE
    location: "{{ primary_azure_region }}"
    vm_size: Standard_D4
    storage_account: examplestorage01aljdl
    admin_username: cookbook
    admin_password: "{{ admin_password }}"
    ssh_public_keys:
    - path: /home/cookbook/.ssh/authorized_keys
      key_data: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCoz5cnrDJSVGVtRR/I3fUeewDg9yTTcF9yDHyzooHO79ERY0a2Ii/ffePpGYfdWr55PoEJG9GIcXjsdyfTHgKJHD+BBVKRjb6kMGGhmCRjH2MSy9Bsom+zGr+YEAM1THF+GMCddq5jcOHBd1+8/zcZu+coCStDVQDrNRbZQlXnTxXYlV2nzF6mF/uyNj62OMNBb39qPdnJQ+RVYJrViQLRrJYL+qaePHdMTD2sljgpco3skCLT1gJ49z8u/o5Is3xDa/CoOgBcYY0nsXp1IU6b3e6whyFPdcuLwqDw+v5bIdD2neGTQUNP0i9ilwofNlN4QBgY3yVlEzilKE9vlmvUcxdh5PSHtszuklXhJuOo+pULq0hsrfPk04ywEOCbjDivm0v8hjthVamHYL50jl4nmjXZ/SCemZPB5KDfgWyGSFc1m1gvxin67um0g1cUa5/xk6sNwxnxDtiFOVhgUP0w1cSe5lnbXWTf5O/b3AX2UUExMzln1QQHIF36H1gH9c2SaEQ8cl5EKMPmOxDQPULFaCHq4gFS1QdXaKiKgfGwoB+eJo8fa8oRi9oU6pM30vNYoC7wlKEVNBDtsWADponQaguN4XJT0qLjJ0jn+M4Nn6fURoyJLD2/kbuK07JgyN6rBiHFgnvF+NmVfdnXfuR/yOlOkH9ACQxS7aPtX9pSiw=="
    image:
      offer: RHEL
      publisher: RedHat
      sku: '7.4'
      version: latest
    network_interfaces: nic02
  tags:
  - recipe04

  - name: Create network security group
  azure_rm_securitygroup:
    resource_group: phonebookApp
    name: mysg01
    purge_rules: yes
    rules:
    - name: 'AllowSSH'
      protocol: TCP
      source_address_prefix: *
      destination_port_range: 22
      access: Allow
      priority: 100
      direction: Inbound
    - name: 'AllowHTTP'
      protocol: TCP
      source_address_prefix: *
      destination_port_range: 80
      priority: 101
      direction: Inbound
    - name: 'AllowHTTPS'
      protocol: TCP
      source_address_prefix: *
      destination_port_range: 443
      priority: 102
      direction: Inbound
    - name: 'DenyAll'
      protocol: TCP
      source_address_prefix: *
      destination_port_range: *
      priority: 103
      direction: Inbound
  tags:
    - recipe5

- name: Create storage container
  azure_rm_storageblob:
     resource_group: phonebookApp
     storage_account_name: examplestorage01aljdl
     container: cookbook
     state: present
  tags:
    - recipe6

- name: Upload a file to existing container
  azure_rm_storageblob:
     resource_group: phonebookApp
     storage_account_name: examplestorage01aljdl
     container: cookbook
     blob: myfile.png
     src: /tmp/myfile.png
     public_access: blob
     content_type: 'application/image'
  tags:
    - recipe6

- name: Download blob object
  azure_rm_storageblob:
     resource_group: phonebookApp
     storage_account_name: examplestorage01aljdl
     container: cookbook
     blob: myfile.png
     dest: /tmp/download_file.png
  tags:
    - recipe6